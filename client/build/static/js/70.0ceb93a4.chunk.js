"use strict";(self.webpackChunkproduct_traceability_client=self.webpackChunkproduct_traceability_client||[]).push([[70],{9070:(e,t,a)=>{a.r(t),a.d(t,{default:()=>f});var r=a(9950),o=a(8429),n=a(9539),l=a(4243),s=a(2570),i=a.n(s),c=a(9095),d=a(8286),u=a(3762),m=a(2959),g=a(9846),h=a(4414);class x extends r.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0}}componentDidCatch(e,t){console.log("Component error caught by boundary:",e,t)}render(){return this.state.hasError?this.props.fallback||null:this.props.children}}const p=e=>{if(!e)return"";console.log("Extracting product ID from QR data:",e);const t=e.match(/\/product\/([^\/\?#]+)/);if(t){const e=t[1];return console.log("Extracted product ID from URL:",e),e}return console.log("Using QR data as direct product ID:",e),e};const f=function(){const e=(0,o.Zp)(),[t,a]=r.useState(null),[s,f]=r.useState(null),[b,v]=r.useState(!1),[y,w]=r.useState("pending"),j=(0,r.useRef)(),N=(0,r.useRef)(null),k=(0,r.useRef)(null),C=(0,r.useRef)(null),F=(0,r.useRef)(null),R=(0,r.useCallback)(()=>{C.current&&(C.current.getTracks().forEach(e=>e.stop()),C.current=null,N.current&&(N.current.srcObject=null)),F.current&&(cancelAnimationFrame(F.current),F.current=null)},[]),S=(0,r.useCallback)(()=>{if(!b)return;if(!N.current)return void console.log("Video reference is null, cannot scan");if(!k.current)return void console.log("Canvas reference is null, cannot scan");if(!C.current)return void console.log("Stream reference is null, cannot scan");const t=N.current,r=k.current;if(!t.readyState||t.readyState<t.HAVE_CURRENT_DATA||!t.videoWidth)F.current=requestAnimationFrame(S);else try{const o=r.getContext("2d",{willReadFrequently:!0});if(!o)return void console.error("Could not get canvas context");r.width=t.videoWidth,r.height=t.videoHeight,o.clearRect(0,0,r.width,r.height),o.drawImage(t,0,0,r.width,r.height);const n=o.getImageData(0,0,r.width,r.height),l=i()(n.data,n.width,n.height,{inversionAttempts:"attemptBoth"});if(o.clearRect(0,0,r.width,r.height),l&&l.data)return console.log("QR code found in video:",l.data),o.beginPath(),o.moveTo(l.location.topLeftCorner.x,l.location.topLeftCorner.y),o.lineTo(l.location.topRightCorner.x,l.location.topRightCorner.y),o.lineTo(l.location.bottomRightCorner.x,l.location.bottomRightCorner.y),o.lineTo(l.location.bottomLeftCorner.x,l.location.bottomLeftCorner.y),o.lineTo(l.location.topLeftCorner.x,l.location.topLeftCorner.y),o.lineWidth=4,o.strokeStyle="#00FF00",o.stroke(),o.font="24px Arial",o.fillStyle="#00FF00",o.textAlign="center",o.fillText("QR Code Detected!",r.width/2,50),v(!1),a(l.data),void setTimeout(()=>{const t=p(l.data);console.log("Extracted product ID:",t),t?(console.log("Navigating to product page:",`/product/${t}`),e(`/product/${t}`)):(f("Invalid QR code format. Could not extract product ID."),R())},1500);{const e=r.width/2,t=r.height/2,a=.6*Math.min(r.width,r.height);o.strokeStyle="#00BFFF",o.lineWidth=3,o.setLineDash([10,10]),o.strokeRect(e-a/2,t-a/2,a,a),o.setLineDash([]);const n=30;o.strokeStyle="#00BFFF",o.lineWidth=4,o.beginPath(),o.moveTo(e-a/2,t-a/2+n),o.lineTo(e-a/2,t-a/2),o.lineTo(e-a/2+n,t-a/2),o.stroke(),o.beginPath(),o.moveTo(e+a/2-n,t-a/2),o.lineTo(e+a/2,t-a/2),o.lineTo(e+a/2,t-a/2+n),o.stroke(),o.beginPath(),o.moveTo(e-a/2,t+a/2-n),o.lineTo(e-a/2,t+a/2),o.lineTo(e-a/2+n,t+a/2),o.stroke(),o.beginPath(),o.moveTo(e+a/2-n,t+a/2),o.lineTo(e+a/2,t+a/2),o.lineTo(e+a/2,t+a/2-n),o.stroke(),o.font="18px Arial",o.fillStyle="#FFFFFF",o.textAlign="center",o.shadowColor="#000000",o.shadowBlur=4,o.fillText("Position QR code in frame",e,t+a/2+40),o.shadowBlur=0}b&&N.current&&(F.current=requestAnimationFrame(S))}catch(o){console.error("Error processing video frame:",o),b&&N.current&&(F.current=requestAnimationFrame(S))}},[b,R,e]),A=(0,r.useCallback)(async()=>{try{if(console.log("Starting camera..."),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return console.error("MediaDevices API or getUserMedia not supported in this browser"),w("unavailable"),void f("Camera access is not available in this browser. Please use the upload option instead.");if(f(null),!N.current)return console.error("Video element not available"),void f("Camera initialization failed - video element not available");if(C.current)try{C.current.getTracks().forEach(e=>e.stop()),C.current=null}catch(e){console.error("Error stopping previous stream:",e)}console.log("Attempting to access rear camera first...");const o={video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}}};let n;try{n=await navigator.mediaDevices.getUserMedia(o),console.log("Successfully accessed rear/environment camera")}catch(t){console.log("Could not access environment camera, falling back to any camera:",t);try{n=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:!1}),console.log("Successfully accessed fallback camera")}catch(a){return console.error("Both camera access attempts failed:",a),w("denied"),void f("Camera access was denied. Please check your browser settings and try again.")}}if(C.current=n,w("granted"),N.current){console.log("Setting video source...");try{N.current.srcObject=n,N.current.onloadedmetadata=()=>{console.log("Video metadata loaded, playing video..."),N.current&&N.current.play().then(()=>{console.log("Video playing, starting QR scan..."),b&&!F.current&&(F.current=requestAnimationFrame(S))}).catch(e=>{console.error("Error starting video playback:",e),f("Could not start camera playback. Please try again.")})},N.current.onplaying=()=>{console.log("Video playing event triggered"),b&&!F.current&&(F.current=requestAnimationFrame(S))},N.current.onerror=e=>{console.error("Video error:",e),f("Video playback error. Please try again.")}}catch(r){console.error("Error setting video source:",r),f("Failed to connect to camera. Please try again.")}}else console.error("Video reference not available"),f("Camera element not available. Please reload the page.")}catch(e){console.error("Camera access error:",e),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?(w("denied"),f("Camera access was denied. Please enable camera permissions and try again.")):"NotFoundError"===e.name||"DevicesNotFoundError"===e.name?(w("unavailable"),f("No camera found on your device. Please use the upload option instead.")):(w("unavailable"),f(`Camera error: ${e.message||"Unknown error"}`))}},[b,S]);return r.useEffect(()=>(b?A():R(),()=>{R()}),[b,A,R]),(0,h.jsxs)("div",{className:"min-h-screen relative overflow-hidden",children:[(0,h.jsx)("div",{className:"absolute inset-0 z-0",children:(0,h.jsx)(x,{fallback:(0,h.jsx)("div",{className:"w-full h-full bg-gradient-to-br from-blue-900 to-purple-900"}),children:(0,h.jsx)(r.Suspense,{fallback:(0,h.jsx)("div",{children:"Loading 3D scene..."}),children:(0,h.jsx)(m.A,{suppressErrors:!0})})})}),(0,h.jsx)(x,{fallback:null,children:(0,h.jsx)(r.Suspense,{fallback:null,children:(0,h.jsx)(c.A,{density:30})})}),(0,h.jsx)("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-900/20 via-purple-900/20 to-cyan-900/20 z-10"}),(0,h.jsx)("div",{className:"relative z-20 min-h-screen flex items-center justify-center p-4",children:(0,h.jsx)(x,{fallback:(0,h.jsxs)("div",{className:"bg-white/10 backdrop-blur-md p-8 rounded-2xl max-w-md w-full",children:[(0,h.jsx)("h2",{className:"text-2xl text-white font-bold mb-4",children:"QR Code Scanner"}),(0,h.jsx)("p",{className:"text-white/80 mb-6",children:"Something went wrong with the scanner. Please try again."}),(0,h.jsx)("button",{onClick:()=>window.location.reload(),className:"w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg",children:"Reload Scanner"})]}),children:(0,h.jsx)(u.A,{className:"w-full max-w-md",children:(0,h.jsxs)("div",{className:"p-8",children:[(0,h.jsxs)("div",{className:"text-center mb-8",children:[(0,h.jsxs)("div",{className:"relative inline-block mb-4",children:[(0,h.jsx)("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,h.jsx)(l.Acq,{className:"text-white text-3xl"})}),(0,h.jsx)("div",{className:"absolute -top-2 -right-2",children:(0,h.jsx)(x,{fallback:null,children:(0,h.jsx)(r.Suspense,{fallback:null,children:(0,h.jsx)(g.A,{size:.5,className:"w-12 h-12"})})})})]}),(0,h.jsx)("h2",{className:"text-3xl font-bold mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent",children:"QR Code Scanner"}),(0,h.jsx)("p",{className:"text-gray-600 dark:text-gray-300",children:"Scan a QR code to view product details"})]}),(0,h.jsxs)("div",{className:"space-y-6",children:[(0,h.jsxs)("div",{className:"relative",children:[(0,h.jsx)("div",{className:"w-full h-72 rounded-2xl overflow-hidden border-2 border-blue-200 dark:border-blue-800 shadow-lg bg-gray-900",children:(0,h.jsxs)("div",{style:{position:"relative",width:"100%",height:"100%"},children:[(0,h.jsx)("video",{ref:N,style:{display:b?"block":"none",width:"100%",height:"100%",objectFit:"cover"},playsInline:!0,muted:!0,autoPlay:!0}),(0,h.jsx)("canvas",{ref:k,style:{display:b?"block":"none",position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover",pointerEvents:"none",zIndex:10}}),!b&&(0,h.jsx)("div",{className:"absolute inset-0 w-full h-full flex items-center justify-center bg-gray-800",children:(0,h.jsx)("div",{className:"text-center",children:"denied"===y?(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(l.BS8,{className:"mx-auto text-4xl text-yellow-500 mb-4"}),(0,h.jsx)("p",{className:"text-yellow-400",children:"Camera access denied"}),(0,h.jsx)("p",{className:"text-gray-400 text-sm mt-2",children:"Please enable camera access in your browser settings"})]}):"unavailable"===y?(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(l.BS8,{className:"mx-auto text-4xl text-yellow-500 mb-4"}),(0,h.jsx)("p",{className:"text-yellow-400",children:"Camera not available"}),(0,h.jsx)("p",{className:"text-gray-400 text-sm mt-2",children:"Please use the upload option below"})]}):(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(l.p5B,{className:"mx-auto text-4xl text-gray-500 mb-4"}),(0,h.jsx)("p",{className:"text-gray-400",children:"Camera will appear here when scanning"})]})})})]})}),b&&(0,h.jsxs)(n.P.div,{initial:{opacity:0},animate:{opacity:1},className:"absolute top-2 left-2 right-2 z-20 flex justify-between items-center",children:[(0,h.jsx)("div",{className:"bg-green-600/90 text-white px-3 py-1 rounded-lg text-sm font-medium",children:"\ud83d\udd0d Scanning for QR Code..."}),(0,h.jsx)("div",{className:"bg-blue-600/90 text-white px-3 py-1 rounded-lg text-sm font-medium",children:"\ud83d\udcf1 Position QR in frame"})]})]}),(0,h.jsxs)("div",{className:"text-center",children:[(0,h.jsxs)("div",{className:"flex items-center justify-center space-x-4 mb-4",children:[(0,h.jsx)("div",{className:"flex-1 h-px bg-gray-300 dark:bg-gray-600"}),(0,h.jsx)("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"or"}),(0,h.jsx)("div",{className:"flex-1 h-px bg-gray-300 dark:bg-gray-600"})]}),(0,h.jsxs)(d.A,{onClick:()=>j.current.click(),className:"w-full py-3 font-semibold",glowColor:"purple",children:[(0,h.jsx)(l.HVe,{className:"mr-2"}),"Upload QR Image"]}),(0,h.jsx)("input",{type:"file",accept:"image/*",ref:j,className:"hidden",onChange:t=>{f(null),a(null);const r=t.target.files[0];if(!r)return;if(!r.type.startsWith("image/"))return void f("Please select an image file.");console.log("Processing uploaded file:",r.name,r.type,r.size);const o=new FileReader;o.onload=function(t){const r=new window.Image;r.onload=function(){console.log("Image loaded, dimensions:",r.width,"x",r.height);const t=document.createElement("canvas");t.width=r.width,t.height=r.height;const o=t.getContext("2d");o.drawImage(r,0,0,r.width,r.height);try{const t=o.getImageData(0,0,r.width,r.height);let n=i()(t.data,t.width,t.height,{inversionAttempts:"attemptBoth"});if(!n||!n.data){console.log("First QR scan attempt failed, trying different resolutions...");const e=document.createElement("canvas"),t=e.getContext("2d");e.width=1024,e.height=r.height/r.width*1024,t.drawImage(r,0,0,e.width,e.height);const a=t.getImageData(0,0,e.width,e.height);n=i()(a.data,a.width,a.height,{inversionAttempts:"attemptBoth"})}if(n&&n.data){console.log("QR code found in uploaded image:",n.data),a(n.data);const t=p(n.data);console.log("Extracted product ID:",t),t?(console.log("Navigating to:",`/product/${t}`),setTimeout(()=>{e(`/product/${t}`)},1e3)):f("Invalid QR code format. Could not extract product ID.")}else f("No QR code found in the image. Try uploading a clearer image or use camera scanning.")}catch(n){console.error("Error processing uploaded image:",n),f("Error processing image. Please try a different image.")}},r.onerror=function(e){console.error("Failed to load uploaded image:",e),f("Failed to load image. The file might be corrupted or not a valid image.")},r.src=t.target.result},o.onerror=function(e){console.error("Failed to read file:",e),f("Failed to read file. Please try again.")},o.readAsDataURL(r)}})]}),t&&(0,h.jsxs)(n.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800",children:[(0,h.jsx)("p",{className:"text-green-800 dark:text-green-200 text-sm",children:(0,h.jsx)("strong",{children:"Scanned Successfully:"})}),(0,h.jsx)("p",{className:"text-green-600 dark:text-green-300 font-mono text-xs break-all mt-1",children:t}),(0,h.jsxs)("div",{className:"mt-3 flex items-center text-green-600 dark:text-green-400 text-sm",children:[(0,h.jsx)("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),"Redirecting to product page..."]})]}),s&&(0,h.jsx)(n.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800",children:(0,h.jsxs)("p",{className:"text-red-800 dark:text-red-200 text-sm",children:[(0,h.jsx)("strong",{children:"Error:"})," ",s]})}),(0,h.jsxs)("div",{className:"flex space-x-4",children:[(0,h.jsxs)(d.A,{onClick:()=>e("/"),variant:"secondary",className:"flex-1 py-3 font-semibold",glowColor:"blue",children:[(0,h.jsx)(l.QVr,{className:"mr-2"}),"Back to Home"]}),(0,h.jsxs)(d.A,{onClick:()=>{b?(v(!1),f(null),a(null)):(v(!0),f(null),a(null))},className:"flex-1 py-3 font-semibold",glowColor:"green",disabled:"unavailable"===y,children:[(0,h.jsx)(l.p5B,{className:"mr-2"}),b?"Stop Scan":"Start Camera Scan"]})]})]})]})})})})]})}}}]);